<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OFF / Tangent — Demo UI</title>
  <style>
    :root{--bg:#0b0e14;--panel:#111827;--panel2:#0f172a;--text:#e5e7eb;--muted:#9ca3af;--line:#243244;--good:#34d399;--bad:#fb7185;--warn:#fbbf24;--btn:#1f2937;--btn2:#111827;--accent:#60a5fa}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto; background:linear-gradient(180deg,#070a10, #0b0e14 35%); color:var(--text)}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:22px}
    .top{display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap}
    .card{background:rgba(17,24,39,.75);border:1px solid var(--line);border-radius:14px;padding:14px;backdrop-filter: blur(8px)}
    .grow{flex:1;min-width:320px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1;min-width:160px}
    label{display:block;font-size:12px;color:var(--muted);margin:2px 0 6px}
    input,select,textarea{width:100%;padding:10px 10px;border-radius:12px;border:1px solid var(--line);background:rgba(15,23,42,.65);color:var(--text);outline:none}
    textarea{min-height:110px;resize:vertical}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{cursor:pointer;border:1px solid var(--line);background:rgba(31,41,55,.7);color:var(--text);padding:10px 12px;border-radius:12px;font-weight:600}
    button:hover{border-color:#38516d}
    button.primary{background:rgba(96,165,250,.15);border-color:rgba(96,165,250,.45)}
    button.danger{background:rgba(251,113,133,.12);border-color:rgba(251,113,133,.45)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(15,23,42,.6);color:var(--muted);font-size:12px}
    .status-dot{width:8px;height:8px;border-radius:50%}
    .dot-good{background:var(--good)}
    .dot-bad{background:var(--bad)}
    .dot-warn{background:var(--warn)}
    h1{margin:0 0 6px;font-size:20px}
    .sub{color:var(--muted);font-size:13px;line-height:1.45}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0 0}
    .tab{padding:8px 10px;border-radius:12px;border:1px solid var(--line);background:rgba(15,23,42,.55);color:var(--muted);cursor:pointer;font-weight:700;font-size:12px}
    .tab.active{color:var(--text);border-color:rgba(96,165,250,.5);background:rgba(96,165,250,.10)}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px;margin-top:14px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .log{white-space:pre-wrap;word-break:break-word;line-height:1.35;font-size:12px;color:#cbd5e1;background:rgba(2,6,23,.65);border:1px solid var(--line);border-radius:14px;padding:12px;min-height:280px;max-height:520px;overflow:auto}
    .mini{font-size:11px;color:var(--muted)}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 680px){.split{grid-template-columns:1fr}}
    .hr{height:1px;background:var(--line);margin:12px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="card grow">
        <h1>OFF / Tangent — Demo UI</h1>
        <div class="sub">Single-file UI to seed, create signals/offers, accept, message, and log idempotency. Stores keys locally in your browser (localStorage). For prototype use only.</div>
        <div class="tabs" id="tabs">
          <div class="tab active" data-tab="happy">Happy Path</div>
          <div class="tab" data-tab="signals">Signals</div>
          <div class="tab" data-tab="offers">Offers</div>
          <div class="tab" data-tab="messages">Messages</div>
          <div class="tab" data-tab="trust">Trust Events</div>
          <div class="tab" data-tab="debug">Debug</div>
        </div>
      </div>

      <div class="card" style="min-width:320px;max-width:420px">
        <div class="row">
          <div style="flex:1;min-width:220px">
            <label>Base URL</label>
            <input id="baseUrl" placeholder="https://off-backend.onrender.com" />
          </div>
          <div style="flex:0.9;min-width:160px">
            <label>Idempotency key prefix</label>
            <input id="idemPrefix" placeholder="demo" />
          </div>
        </div>
        <div class="split" style="margin-top:10px">
          <div>
            <label>Admin key</label>
            <input id="kAdmin" placeholder="Bearer …" class="mono" />
          </div>
          <div>
            <label>Concierge key</label>
            <input id="kConc" placeholder="Bearer …" class="mono" />
          </div>
        </div>
        <div class="split" style="margin-top:10px">
          <div>
            <label>Guest key</label>
            <input id="kGuest" placeholder="Bearer …" class="mono" />
          </div>
          <div>
            <label>Actor ID header (optional)</label>
            <input id="actorId" placeholder="guest_seed" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div class="pill" id="healthPill" title="Health status">
            <span class="status-dot dot-warn" id="healthDot"></span>
            <span id="healthText">Not checked</span>
          </div>
          <div class="btns" style="justify-content:flex-end">
            <button id="btnSave" class="primary">Save</button>
            <button id="btnHealth">/health</button>
            <button id="btnClear" class="danger">Clear UI cache</button>
          </div>
        </div>
        <div class="mini" style="margin-top:8px">Tip: paste the raw token (not including “Bearer”) — the UI adds <span class="mono">Authorization: Bearer …</span> automatically.</div>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="panelLeft"></div>
      <div class="card">
        <div class="row" style="align-items:flex-end">
          <div style="flex:1">
            <label>Quick actions</label>
            <div class="btns">
              <button class="primary" id="btnSeed">Seed happy-path</button>
              <button id="btnGuestOverview">Guest overview</button>
              <button id="btnConcOverview">Concierge overview</button>
              <button id="btnStore">Debug store</button>
            </div>
          </div>
          <div style="flex:0.6;min-width:200px">
            <label>Selected IDs</label>
            <div class="pill mono" id="selPill">sig: —  • off: —  • vib: —</div>
          </div>
        </div>
        <div class="hr"></div>
        <label>Response log</label>
        <div class="log mono" id="log"></div>
      </div>
    </div>
  </div>

<script>
  // --------- tiny client ---------
  const $ = (id) => document.getElementById(id);
  const logEl = $("log");

  const state = {
    tab: "happy",
    selected: { signal_id: null, offer_id: null, vibe_id: null },
    seed: { guest_handle: "guest_seed", concierge_handle: "conc_seed", guest_id: "guest_seed", concierge_id: "conc_seed" }
  };

  function nowIdem(prefix){
    const ts = new Date().toISOString().replace(/[:.]/g,"-");
    return `${prefix}-${state.tab}-${ts}`;
  }

  function setHealth(status, msg){
    const dot = $("healthDot");
    const text = $("healthText");
    text.textContent = msg;
    dot.className = "status-dot " + (status === "ok" ? "dot-good" : status === "bad" ? "dot-bad" : "dot-warn");
  }

  function writeLog(title, obj){
    const t = `\n\n=== ${title} ===\n`;
    const body = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    logEl.textContent = (t + body + "\n" + logEl.textContent).slice(0, 25000);
  }

  function getCfg(){
    const baseUrl = $("baseUrl").value.trim().replace(/\/$/,"") || "https://off-backend.onrender.com";
    const idemPrefix = $("idemPrefix").value.trim() || "demo";
    const admin = $("kAdmin").value.trim();
    const conc = $("kConc").value.trim();
    const guest = $("kGuest").value.trim();
    const actorId = $("actorId").value.trim();
    return { baseUrl, idemPrefix, keys: { admin, conc, guest }, actorId };
  }

  function authHeader(role){
    const { keys } = getCfg();
    const token = (role === "admin" ? keys.admin : role === "conc" ? keys.conc : keys.guest) || "";
    const raw = token.startsWith("Bearer ") ? token.slice(7).trim() : token;
    return raw ? { "Authorization": `Bearer ${raw}` } : {};
  }

  async function api(path, { method="GET", role=null, idemKey=null, json=null, headers={} } = {}){
    const cfg = getCfg();
    const url = cfg.baseUrl + path;

    const h = { ...headers };
    if (role) Object.assign(h, authHeader(role));
    if (idemKey) h["Idempotency-Key"] = idemKey;
    if (cfg.actorId) h["X-Actor-Id"] = cfg.actorId;
    if (json) h["Content-Type"] = "application/json";

    const res = await fetch(url, {
      method,
      headers: h,
      body: json ? JSON.stringify(json) : undefined
    });

    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }

    return {
      ok: res.ok,
      status: res.status,
      headers: Object.fromEntries(res.headers.entries()),
      data
    };
  }

  function setSelected({ signal_id=null, offer_id=null, vibe_id=null } = {}){
    if (signal_id !== null) state.selected.signal_id = signal_id;
    if (offer_id !== null) state.selected.offer_id = offer_id;
    if (vibe_id !== null) state.selected.vibe_id = vibe_id;
    $("selPill").textContent = `sig: ${state.selected.signal_id || "—"}  • off: ${state.selected.offer_id || "—"}  • vib: ${state.selected.vibe_id || "—"}`;
  }

  // --------- UI panels ---------
  function render(){
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === state.tab));
    const left = $("panelLeft");

    if (state.tab === "happy"){
      left.innerHTML = `
        <h2 style="margin:0 0 10px;font-size:16px">Happy Path</h2>
        <div class="sub">One-click-ish demo: seed → create new signal → create offer → accept → message → trust event.</div>
        <div class="hr"></div>
        <div class="split">
          <div>
            <label>Guest id (body)</label>
            <input id="hpGuestId" value="guest_seed" />
          </div>
          <div>
            <label>Concierge id (body)</label>
            <input id="hpConcId" value="conc_seed" />
          </div>
        </div>
        <div style="margin-top:10px">
          <label>Signal intent</label>
          <input id="hpIntent" value="Sunrise balcony coffee" />
        </div>
        <div class="split" style="margin-top:10px">
          <div>
            <label>Location</label>
            <input id="hpLoc" value="NYC" />
          </div>
          <div>
            <label>Offer price</label>
            <input id="hpPrice" type="number" value="20" />
          </div>
        </div>
        <div style="margin-top:10px">
          <label>Offer message</label>
          <input id="hpOfferMsg" value="I can meet you at 7:30 near Riverside." />
        </div>
        <div style="margin-top:10px" class="btns">
          <button class="primary" id="hpRun">Run happy-path (no-seed)</button>
          <button id="hpMsg">Post message (selected vibe)</button>
          <button id="hpTev">Post trust event (selected vibe)</button>
        </div>
        <div class="mini" style="margin-top:10px">This uses:<span class="mono"> POST /signals → POST /offers → POST /offers/:id/accept</span>. It sets Selected IDs when it succeeds.</div>
      `;

      $("hpRun").onclick = async () => {
        const cfg = getCfg();
        const guest_id = $("hpGuestId").value.trim();
        const concierge_id = $("hpConcId").value.trim();
        const intent = $("hpIntent").value.trim();
        const location = $("hpLoc").value.trim();
        const price = Number($("hpPrice").value || 0);
        const message = $("hpOfferMsg").value.trim();

        // create signal
        const r1 = await api(`/signals`, { method:"POST", role:"guest", idemKey: `${cfg.idemPrefix}-sig-001`, json:{ guest_id, intent, location } });
        writeLog(`POST /signals (${r1.status})`, { headers: pick(r1.headers, ["idempotency-replay","x-request-id"]), body: r1.data });
        const signal_id = r1.data?.signal?.id || null;
        if (!signal_id) return;
        setSelected({ signal_id, offer_id:null, vibe_id:null });

        // create offer
        const r2 = await api(`/offers`, { method:"POST", role:"conc", idemKey: `${cfg.idemPrefix}-off-001`, json:{ signal_id, concierge_id, message, price } });
        writeLog(`POST /offers (${r2.status})`, { headers: pick(r2.headers, ["idempotency-replay","x-request-id"]), body: r2.data });
        const offer_id = r2.data?.offer?.id || null;
        if (!offer_id) return;
        setSelected({ offer_id });

        // accept offer
        const r3 = await api(`/offers/${offer_id}/accept`, { method:"POST", role:"guest", idemKey: `${cfg.idemPrefix}-acc-001`, json:{ guest_id } });
        writeLog(`POST /offers/${offer_id}/accept (${r3.status})`, { headers: pick(r3.headers, ["idempotency-replay","x-request-id"]), body: r3.data });
        const vibe_id = r3.data?.vibe?.id || r3.data?.details?.vibe_id || null;
        if (vibe_id) setSelected({ vibe_id });
      };

      $("hpMsg").onclick = async () => {
        const cfg = getCfg();
        const vibe_id = state.selected.vibe_id || "vib_seed_001";
        const from_role = "guest";
        const from_id = $("hpGuestId")?.value?.trim() || "guest_seed";
        const r = await api(`/messages`, { method:"POST", role:"guest", idemKey: nowIdem(cfg.idemPrefix), json:{ vibe_id, from_role, from_id, text:"Hello from UI" } });
        writeLog(`POST /messages (${r.status})`, { headers: pick(r.headers, ["idempotency-replay","x-request-id"]), body: r.data });
      };

      $("hpTev").onclick = async () => {
        const cfg = getCfg();
        const vibe_id = state.selected.vibe_id || "vib_seed_001";
        const actor_id = $("hpGuestId")?.value?.trim() || "guest_seed";
        const r = await api(`/trustevents`, { method:"POST", role:"guest", idemKey: nowIdem(cfg.idemPrefix), json:{ vibe_id, event_type:"checkin", actor_role:"guest", actor_id, payload:{ note:"Arrived" } } });
        writeLog(`POST /trustevents (${r.status})`, { headers: pick(r.headers, ["idempotency-replay","x-request-id"]), body: r.data });
      };

      return;
    }

    if (state.tab === "signals"){
      left.innerHTML = `
        <h2 style="margin:0 0 10px;font-size:16px">Signals</h2>
        <div class="split">
          <div>
            <label>guest_id (filter)</label>
            <input id="sigGuest" value="guest_seed" />
          </div>
          <div>
            <label>status (filter)</label>
            <select id="sigStatus">
              <option value="">(any)</option>
              <option>pending</option>
              <option>offered</option>
              <option>matched</option>
              <option>completed</option>
              <option>canceled</option>
            </select>
          </div>
        </div>
        <div class="btns" style="margin-top:10px">
          <button class="primary" id="sigList">List</button>
          <button id="sigCreate">Create</button>
        </div>
        <div style="margin-top:10px">
          <label>Create intent</label>
          <input id="sigIntent" value="Micro-break walk" />
        </div>
        <div class="split" style="margin-top:10px">
          <div>
            <label>Create location</label>
            <input id="sigLoc" value="NYC" />
          </div>
          <div>
            <label>Idempotency key (optional)</label>
            <input id="sigIdem" placeholder="leave blank to auto" />
          </div>
        </div>
      `;

      $("sigList").onclick = async () => {
        const guest_id = $("sigGuest").value.trim();
        const status = $("sigStatus").value.trim();
        const q = new URLSearchParams();
        if (guest_id) q.set("guest_id", guest_id);
        if (status) q.set("status", status);
        const r = await api(`/signals?${q.toString()}`, { role:"guest" });
        writeLog(`GET /signals (${r.status})`, r.data);
        const first = r.data?.items?.[0]?.id || null;
        if (first) setSelected({ signal_id:first });
      };

      $("sigCreate").onclick = async () => {
        const cfg = getCfg();
        const guest_id = $("sigGuest").value.trim() || "guest_seed";
        const intent = $("sigIntent").value.trim();
        const location = $("sigLoc").value.trim();
        const idem = $("sigIdem").value.trim() || nowIdem(cfg.idemPrefix);
        const r = await api(`/signals`, { method:"POST", role:"guest", idemKey: idem, json:{ guest_id, intent, location } });
        writeLog(`POST /signals (${r.status})`, { headers: pick(r.headers,["idempotency-replay","x-request-id"]), body:r.data });
        const id = r.data?.signal?.id || null;
        if (id) setSelected({ signal_id:id });
      };

      return;
    }

    if (state.tab === "offers"){
      left.innerHTML = `
        <h2 style="margin:0 0 10px;font-size:16px">Offers</h2>
        <div class="split">
          <div>
            <label>signal_id (filter)</label>
            <input id="offSignal" placeholder="sig_..." value="${state.selected.signal_id || "sig_seed_001"}" />
          </div>
          <div>
            <label>concierge_id (filter)</label>
            <input id="offConc" value="conc_seed" />
          </div>
        </div>
        <div class="btns" style="margin-top:10px">
          <button class="primary" id="offList">List</button>
          <button id="offCreate">Create</button>
          <button id="offAccept">Accept selected offer</button>
        </div>
        <div class="hr"></div>
        <div class="split">
          <div>
            <label>Create offer: message</label>
            <input id="offMsg" value="Offer from UI" />
          </div>
          <div>
            <label>Create offer: price</label>
            <input id="offPrice" type="number" value="20" />
          </div>
        </div>
        <div class="split" style="margin-top:10px">
          <div>
            <label>Create offer: concierge_id (body)</label>
            <input id="offConcBody" value="conc_seed" />
          </div>
          <div>
            <label>Idempotency key (optional)</label>
            <input id="offIdem" placeholder="leave blank to auto" />
          </div>
        </div>
        <div style="margin-top:10px">
          <label>Accept offer: guest_id (body)</label>
          <input id="accGuest" value="guest_seed" />
        </div>
      `;

      $("offList").onclick = async () => {
        const q = new URLSearchParams();
        const signal_id = $("offSignal").value.trim();
        const concierge_id = $("offConc").value.trim();
        if (signal_id) q.set("signal_id", signal_id);
        if (concierge_id) q.set("concierge_id", concierge_id);
        const r = await api(`/offers?${q.toString()}`, { role:"conc" });
        writeLog(`GET /offers (${r.status})`, r.data);
        const first = r.data?.items?.[0]?.id || null;
        if (first) setSelected({ offer_id:first });
      };

      $("offCreate").onclick = async () => {
        const cfg = getCfg();
        const signal_id = $("offSignal").value.trim();
        const concierge_id = $("offConcBody").value.trim();
        const message = $("offMsg").value.trim();
        const price = Number($("offPrice").value || 0);
        const idem = $("offIdem").value.trim() || nowIdem(cfg.idemPrefix);
        const r = await api(`/offers`, { method:"POST", role:"conc", idemKey: idem, json:{ signal_id, concierge_id, message, price } });
        writeLog(`POST /offers (${r.status})`, { headers: pick(r.headers,["idempotency-replay","x-request-id"]), body:r.data });
        const id = r.data?.offer?.id || null;
        if (id) setSelected({ offer_id:id });
      };

      $("offAccept").onclick = async () => {
        const cfg = getCfg();
        const offer_id = state.selected.offer_id;
        if (!offer_id) return writeLog("Accept offer", "No selected offer_id. List offers first.");
        const guest_id = $("accGuest").value.trim();
        const r = await api(`/offers/${offer_id}/accept`, { method:"POST", role:"guest", idemKey: nowIdem(cfg.idemPrefix), json:{ guest_id } });
        writeLog(`POST /offers/${offer_id}/accept (${r.status})`, { headers: pick(r.headers,["idempotency-replay","x-request-id"]), body:r.data });
        const vibe_id = r.data?.vibe?.id || r.data?.details?.vibe_id || null;
        if (vibe_id) setSelected({ vibe_id });
      };

      return;
    }

    if (state.tab === "messages"){
      left.innerHTML = `
        <h2 style="margin:0 0 10px;font-size:16px">Messages</h2>
        <div class="split">
          <div>
            <label>vibe_id</label>
            <input id="mVibe" value="${state.selected.vibe_id || "vib_seed_001"}" />
          </div>
          <div>
            <label>actor_id (query)</label>
            <input id="mActor" value="guest_seed" />
          </div>
        </div>
        <div class="btns" style="margin-top:10px">
          <button class="primary" id="mList">List</button>
          <button id="mPost">Post</button>
        </div>
        <div class="split" style="margin-top:10px">
          <div>
            <label>from_role</label>
            <select id="mRole"><option>guest</option><option>concierge</option></select>
          </div>
          <div>
            <label>from_id</label>
            <input id="mFrom" value="guest_seed" />
          </div>
        </div>
        <div style="margin-top:10px">
          <label>text</label>
          <input id="mText" value="hello from UI" />
        </div>
      `;

      $("mList").onclick = async () => {
        const vibe_id = $("mVibe").value.trim();
        const actor_id = $("mActor").value.trim();
        const q = new URLSearchParams({ vibe_id, actor_id });
        const r = await api(`/messages?${q.toString()}`, { role: ( $("mRole").value === "concierge" ? "conc" : "guest" ) });
        writeLog(`GET /messages (${r.status})`, r.data);
      };

      $("mPost").onclick = async () => {
        const cfg = getCfg();
        const vibe_id = $("mVibe").value.trim();
        const from_role = $("mRole").value;
        const from_id = $("mFrom").value.trim();
        const text = $("mText").value.trim();
        const role = from_role === "concierge" ? "conc" : "guest";
        const r = await api(`/messages`, { method:"POST", role, idemKey: nowIdem(cfg.idemPrefix), json:{ vibe_id, from_role, from_id, text } });
        writeLog(`POST /messages (${r.status})`, { headers: pick(r.headers,["idempotency-replay","x-request-id"]), body:r.data });
      };

      return;
    }

    if (state.tab === "trust"){
      left.innerHTML = `
        <h2 style="margin:0 0 10px;font-size:16px">Trust Events</h2>
        <div class="split">
          <div>
            <label>vibe_id</label>
            <input id="tVibe" value="${state.selected.vibe_id || "vib_seed_001"}" />
          </div>
          <div>
            <label>actor_id (query)</label>
            <input id="tActor" value="guest_seed" />
          </div>
        </div>
        <div class="btns" style="margin-top:10px">
          <button class="primary" id="tList">List</button>
          <button id="tPost">Post</button>
        </div>
        <div class="split" style="margin-top:10px">
          <div>
            <label>event_type</label>
            <select id="tType"><option>checkin</option><option>checkout</option><option>flag</option><option>note</option></select>
          </div>
          <div>
            <label>actor_role</label>
            <select id="tRole"><option>guest</option><option>concierge</option></select>
          </div>
        </div>
        <div class="split" style="margin-top:10px">
          <div>
            <label>actor_id (body)</label>
            <input id="tActorBody" value="guest_seed" />
          </div>
          <div>
            <label>payload.note</label>
            <input id="tNote" value="Arrived" />
          </div>
        </div>
      `;

      $("tList").onclick = async () => {
        const vibe_id = $("tVibe").value.trim();
        const actor_id = $("tActor").value.trim();
        const role = $("tRole").value === "concierge" ? "conc" : "guest";
        const q = new URLSearchParams({ vibe_id, actor_id });
        const r = await api(`/trustevents?${q.toString()}`, { role });
        writeLog(`GET /trustevents (${r.status})`, r.data);
      };

      $("tPost").onclick = async () => {
        const cfg = getCfg();
        const vibe_id = $("tVibe").value.trim();
        const event_type = $("tType").value;
        const actor_role = $("tRole").value;
        const actor_id = $("tActorBody").value.trim();
        const payload = { note: $("tNote").value.trim() };
        const role = actor_role === "concierge" ? "conc" : "guest";
        const r = await api(`/trustevents`, { method:"POST", role, idemKey: nowIdem(cfg.idemPrefix), json:{ vibe_id, event_type, actor_role, actor_id, payload } });
        writeLog(`POST /trustevents (${r.status})`, { headers: pick(r.headers,["idempotency-replay","x-request-id"]), body:r.data });
      };

      return;
    }

    // debug
    left.innerHTML = `
      <h2 style="margin:0 0 10px;font-size:16px">Debug</h2>
      <div class="sub">Admin-only helpers. These endpoints should be disabled behind a flag before any real launch.</div>
      <div class="hr"></div>
      <div class="btns">
        <button class="primary" id="dSeed">POST /debug/seed</button>
        <button id="dReset" class="danger">POST /debug/reset</button>
        <button id="dStore">GET /debug/store</button>
      </div>
      <div style="margin-top:10px">
        <label>Idempotency key (seed/reset)</label>
        <input id="dIdem" placeholder="leave blank to auto" />
      </div>
    `;

    $("dSeed").onclick = async () => {
      const cfg = getCfg();
      const idem = $("dIdem").value.trim() || nowIdem(cfg.idemPrefix);
      const r = await api(`/debug/seed`, { method:"POST", role:"admin", idemKey: idem });
      writeLog(`POST /debug/seed (${r.status})`, { headers: pick(r.headers,["idempotency-replay","x-request-id"]), body:r.data });
      // best-effort set selection
      if (r.data?.ids?.signal_id) setSelected({ signal_id: r.data.ids.signal_id, offer_id:r.data.ids.offer_id, vibe_id:r.data.ids.vibe_id });
    };

    $("dReset").onclick = async () => {
      const cfg = getCfg();
      const idem = $("dIdem").value.trim() || nowIdem(cfg.idemPrefix);
      const r = await api(`/debug/reset`, { method:"POST", role:"admin", idemKey: idem });
      writeLog(`POST /debug/reset (${r.status})`, { headers: pick(r.headers,["idempotency-replay","x-request-id"]), body:r.data });
      setSelected({ signal_id:null, offer_id:null, vibe_id:null });
    };

    $("dStore").onclick = async () => {
      const r = await api(`/debug/store`, { role:"admin" });
      writeLog(`GET /debug/store (${r.status})`, r.data);
    };
  }

  function pick(obj, keys){
    const out = {};
    keys.forEach(k => { if (obj && obj[k] != null) out[k] = obj[k]; });
    return out;
  }

  // --------- top actions ---------
  $("tabs").addEventListener("click", (e) => {
    const el = e.target.closest(".tab");
    if (!el) return;
    state.tab = el.dataset.tab;
    render();
  });

  $("btnSave").onclick = () => {
    const cfg = getCfg();
    localStorage.setItem("off_demo_cfg", JSON.stringify({
      baseUrl: cfg.baseUrl,
      idemPrefix: cfg.idemPrefix,
      keys: cfg.keys,
      actorId: cfg.actorId
    }));
    writeLog("Saved", { baseUrl: cfg.baseUrl, idemPrefix: cfg.idemPrefix, actorId: cfg.actorId, keys: { admin: !!cfg.keys.admin, conc: !!cfg.keys.conc, guest: !!cfg.keys.guest } });
  };

  $("btnClear").onclick = () => {
    localStorage.removeItem("off_demo_cfg");
    logEl.textContent = "";
    setHealth("warn","Not checked");
    writeLog("Cleared", "localStorage + log cleared.");
  };

  $("btnHealth").onclick = async () => {
    try{
      const r = await api(`/health`);
      setHealth(r.ok ? "ok" : "bad", r.ok ? "OK" : `HTTP ${r.status}`);
      writeLog(`GET /health (${r.status})`, r.data);
    }catch(err){
      setHealth("bad","Network error");
      writeLog("GET /health (error)", String(err));
    }
  };

  $("btnSeed").onclick = async () => {
    const cfg = getCfg();
    const r = await api(`/debug/seed`, { method:"POST", role:"admin", idemKey: `${cfg.idemPrefix}-seed-001` });
    writeLog(`POST /debug/seed (${r.status})`, { headers: pick(r.headers,["idempotency-replay","x-request-id"]), body:r.data });
    if (r.data?.ids?.signal_id) setSelected({ signal_id: r.data.ids.signal_id, offer_id:r.data.ids.offer_id, vibe_id:r.data.ids.vibe_id });
  };

  $("btnGuestOverview").onclick = async () => {
    const guest = "guest_seed";
    const r = await api(`/guests/${guest}/overview`, { role:"guest" });
    writeLog(`GET /guests/${guest}/overview (${r.status})`, r.data);
  };

  $("btnConcOverview").onclick = async () => {
    const conc = "conc_seed";
    const r = await api(`/concierges/${conc}/overview`, { role:"conc" });
    writeLog(`GET /concierges/${conc}/overview (${r.status})`, r.data);
  };

  $("btnStore").onclick = async () => {
    const r = await api(`/debug/store`, { role:"admin" });
    writeLog(`GET /debug/store (${r.status})`, r.data);
  };

  // --------- init ---------
  (function init(){
    const raw = localStorage.getItem("off_demo_cfg");
    if (raw){
      try{
        const cfg = JSON.parse(raw);
        $("baseUrl").value = cfg.baseUrl || "https://off-backend.onrender.com";
        $("idemPrefix").value = cfg.idemPrefix || "demo";
        $("kAdmin").value = cfg.keys?.admin || "";
        $("kConc").value = cfg.keys?.conc || "";
        $("kGuest").value = cfg.keys?.guest || "";
        $("actorId").value = cfg.actorId || "";
      }catch{}
    }else{
      $("baseUrl").value = "https://off-backend.onrender.com";
      $("idemPrefix").value = "demo";
    }
    render();
  })();
</script>
</body>
</html>
