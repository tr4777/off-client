<!-- index.html ‚Äî OFF / Tangent Demo UI v0.453 (Grand Victory Run) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OFF / Tangent ‚Äî Demo v0.453</title>
  <meta name="description" content="OFF / Tangent demo: Signal ‚Üí Offer ‚Üí Accept ‚Üí Vibe ‚Üí Messages (real API) with pillar status lights." />

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --panel2:#0c131c;
      --text:#e8eef7;
      --muted:#9aa8bb;
      --line:#1b2636;

      --accent:#7dd3fc;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;

      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(125,211,252,.10), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(52,211,153,.08), transparent 55%),
        radial-gradient(1200px 700px at 50% 110%, rgba(251,113,133,.06), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family: var(--sans);
    }

    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 18px 16px 80px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin: 6px 0 14px;
    }

    .brand{ display:flex; flex-direction:column; gap:6px; }
    .title{ display:flex; align-items:center; gap:10px; font-weight: 900; font-size: 18px; letter-spacing: .2px; }
    .tag{
      font-family: var(--mono);
      font-size: 10px;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid rgba(27,38,54,.9);
      background: rgba(17,26,38,.7);
      color: rgba(232,238,247,.85);
    }
    .subtitle{ color: var(--muted); font-size: 12px; line-height: 1.35; max-width: 760px; }

    .topbar{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }

    .statusbar{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      background: rgba(15,22,32,.7);
      border: 1px solid rgba(27,38,54,.8);
      border-radius: 999px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
      white-space: nowrap;
    }
    .dot{ width:10px;height:10px;border-radius:999px; background: rgba(154,168,187,.55); box-shadow: 0 0 0 0 rgba(152,166,184,.0); }
    .dot.good{ background: var(--good); box-shadow: 0 0 0 6px rgba(52,211,153,.10); }
    .dot.warn{ background: var(--warn); box-shadow: 0 0 0 6px rgba(251,191,36,.10); }
    .dot.bad{  background: var(--bad);  box-shadow: 0 0 0 6px rgba(251,113,133,.10); }

    .statusText{ display:flex; flex-direction:column; gap:2px; line-height:1.1; }
    .statusText strong{ font-size: 12px; }
    .statusText span{ font-size: 11px; color: var(--muted); }

    button{
      border: 1px solid rgba(27,38,54,.95);
      background: rgba(17,26,38,.85);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor: pointer;
      font-weight: 820;
      font-size: 12px;
      letter-spacing: .2px;
      transition: transform .06s ease, border-color .15s ease, background .15s ease, opacity .15s ease;
    }
    button:hover{ transform: translateY(-1px); border-color: rgba(125,211,252,.35); }
    button:active{ transform: translateY(0px); }
    button.primary{ background: rgba(125,211,252,.12); border-color: rgba(125,211,252,.35); }
    button.danger{  background: rgba(251,113,133,.10); border-color: rgba(251,113,133,.35); }
    button.ghost{
      background: rgba(17,26,38,.45);
      border-color: rgba(27,38,54,.85);
      padding: 9px 10px;
      border-radius: 12px;
      font-weight: 900;
    }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
      margin-top: 12px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      header{ flex-direction: column; align-items: stretch; }
      .topbar{ justify-content:space-between; }
    }

    .card{
      background: linear-gradient(180deg, rgba(15,22,32,.92), rgba(12,19,28,.92));
      border: 1px solid rgba(27,38,54,.92);
      border-radius: 18px;
      box-shadow: 0 12px 40px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .cardHeader{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(27,38,54,.85);
      display:flex; align-items:center; justify-content:space-between; gap: 10px;
    }
    .cardHeader h2{
      margin:0;
      font-size: 12px;
      letter-spacing: .25px;
      text-transform: uppercase;
      color: rgba(232,238,247,.9);
    }
    .cardBody{ padding: 12px; }
    .tiny{ font-size: 11px; color: var(--muted); line-height: 1.35; }

    /* Pillars */
    .pillars{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 540px){ .pillars{ grid-template-columns: 1fr; } }

    .pillar{
      border: 1px solid rgba(27,38,54,.85);
      background: rgba(11,15,20,.55);
      border-radius: 16px;
      padding: 10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .pillar .dot{ margin-top: 3px; }
    .pillar strong{ display:block; font-size: 12px; letter-spacing:.2px; }
    .pillar span{ display:block; font-size: 11px; color: var(--muted); margin-top: 2px; line-height: 1.25; }

    /* Story lane */
    .lane{ display:flex; flex-direction:column; gap: 10px; min-height: 560px; }
    .stageTitle{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 6px; }
    .stageTitle .pill{
      font-family: var(--mono);
      font-size: 10px;
      color: rgba(232,238,247,.8);
      background: rgba(17,26,38,.55);
      border: 1px solid rgba(27,38,54,.85);
      padding: 5px 8px;
      border-radius: 999px;
    }

    .storyCard{
      border: 1px solid rgba(27,38,54,.9);
      background: rgba(11,15,20,.55);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      position: relative;
      overflow:hidden;
      transform: translateY(6px);
      opacity: 0;
      animation: popIn .35s ease forwards;
    }
    @keyframes popIn{ from{ transform: translateY(10px); opacity: 0; } to{ transform: translateY(0px); opacity: 1; } }

    .storyCard::before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width: 3px;
      background: rgba(125,211,252,.35);
    }

    .storyTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .storyTop strong{ font-size: 13px; letter-spacing: .2px; }

    .badge{
      font-family: var(--mono);
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(27,38,54,.85);
      background: rgba(17,26,38,.65);
      color: rgba(232,238,247,.85);
    }
    .badge.good{ border-color: rgba(52,211,153,.35); background: rgba(52,211,153,.08); }
    .badge.warn{ border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.08); }
    .badge.bad{  border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.08); }

    .kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap: 6px 10px;
      font-size: 12px;
      line-height: 1.3;
    }
    .kv b{ color: var(--muted); font-weight: 800; }

    .divider{ height:1px; background: rgba(27,38,54,.85); margin: 10px 0; }
    .kbd{
      font-family: var(--mono);
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(27,38,54,.9);
      background: rgba(17,26,38,.7);
      color: rgba(232,238,247,.85);
    }

    /* Right panel controls */
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    @media (max-width: 540px){ .row2{ grid-template-columns:1fr; } }

    label{ display:block; font-size: 11px; color: var(--muted); margin: 0 0 6px; }

    .labelRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 6px;
    }
    .labelLeft{
      display:flex; align-items:center; gap:8px;
      color: var(--muted);
      font-size: 11px;
    }
    .keyDot{
      width: 8px; height: 8px;
      border-radius: 999px;
      background: rgba(154,168,187,.55);
      box-shadow: 0 0 0 0 rgba(152,166,184,.0);
    }
    .keyDot.good{ background: var(--good); box-shadow: 0 0 0 5px rgba(52,211,153,.10); }
    .keyDot.warn{ background: var(--warn); box-shadow: 0 0 0 5px rgba(251,191,36,.10); }
    .keyDot.bad{  background: var(--bad);  box-shadow: 0 0 0 5px rgba(251,113,133,.10); }

    input, select{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(27,38,54,.95);
      background: rgba(11,15,20,.65);
      color: var(--text);
      outline: none;
    }

    .terminal{
      margin-top: 10px;
      background: rgba(8,11,16,.70);
      border: 1px solid rgba(27,38,54,.85);
      border-radius: 16px;
      padding: 10px 10px 8px;
      overflow:hidden;
    }
    .terminalTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 8px;
    }
    .dots{ display:flex; gap:6px; align-items:center; }
    .dots span{ width: 9px; height: 9px; border-radius: 999px; background: rgba(152,166,184,.35); }
    .dots span:nth-child(1){ background: rgba(251,113,133,.55); }
    .dots span:nth-child(2){ background: rgba(251,191,36,.55); }
    .dots span:nth-child(3){ background: rgba(52,211,153,.55); }

    .terminalMeta{ display:flex; align-items:center; gap: 8px; color: var(--muted); font-size: 11px; }
    .log{
      font-family: var(--mono);
      font-size: 9px;
      line-height: 1.45;
      color: rgba(232,238,247,.82);
      height: 255px;
      overflow:auto;
      padding-right: 6px;
      white-space: pre-wrap;
    }
    .log .muted{ color: rgba(152,166,184,.78); }
    .log .good{ color: rgba(52,211,153,.92); }
    .log .warn{ color: rgba(251,191,36,.92); }
    .log .bad{ color: rgba(251,113,133,.92); }
    .log .accent{ color: rgba(125,211,252,.92); }

    /* Chat bubbles */
    .chat{
      display:flex;
      flex-direction:column;
      gap: 8px;
      margin-top: 8px;
    }
    .bubble{
      max-width: 85%;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(27,38,54,.85);
      background: rgba(17,26,38,.42);
      line-height: 1.35;
      font-size: 12px;
      color: rgba(232,238,247,.95);
    }
    .bubble.guest{
      margin-right:auto;
      border-top-left-radius: 8px;
      background: rgba(125,211,252,.10);
      border-color: rgba(125,211,252,.28);
    }
    .bubble.concierge{
      margin-left:auto;
      border-top-right-radius: 8px;
      background: rgba(52,211,153,.08);
      border-color: rgba(52,211,153,.22);
    }
    .bubbleMeta{
      font-size: 10px;
      color: rgba(154,168,187,.95);
      margin-top: 4px;
    }
  
    /* Marketplace (staged + real offers) */
    .marketplace{
      margin-top: 12px;
      border: 1px solid rgba(27,38,54,.85);
      background: rgba(11,15,20,.45);
      border-radius: 16px;
      padding: 12px;
    }
    .marketTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
      margin-bottom: 10px;
    }
    .marketTitle{
      font-weight: 700;
      letter-spacing: .2px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .badge{
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,.25);
      background: rgba(56,189,248,.10);
      color: rgba(226,232,240,.9);
    }
    .marketMeta{ text-align:right; display:flex; flex-direction:column; gap:6px; }
    .marketSections{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 900px){ .marketSections{ grid-template-columns: 1fr; } }
    .marketSection{
      border: 1px solid rgba(27,38,54,.65);
      background: rgba(7,11,16,.45);
      border-radius: 14px;
      padding: 10px;
    }
    .marketSectionTitle{ font-weight: 650; margin-bottom: 6px; }
    .marketGrid{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; margin-top: 10px; }
    @media (max-width: 540px){ .marketGrid{ grid-template-columns: 1fr; } }
    .offerTile{
      position:relative;
      border: 1px solid rgba(27,38,54,.8);
      background: rgba(14,20,30,.45);
      border-radius: 14px;
      padding: 10px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      user-select:none;
      min-height: 92px;
    }
    .offerTile:hover{
      transform: translateY(-1px);
      border-color: rgba(125,211,252,.35);
      background: rgba(14,20,30,.58);
    }
    .offerTile.selected{
      border-color: rgba(34,211,238,.55);
      box-shadow: 0 0 0 1px rgba(34,211,238,.25) inset;
    }
    .offerTile .kicker{
      font-size: 11px;
      opacity: .85;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      margin-bottom: 6px;
    }
    .offerTile .title{ font-weight: 700; margin-bottom: 4px; }
    .offerTile .desc{ font-size: 12px; opacity: .86; line-height: 1.25; }
    .pillMini{
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(148,163,184,.08);
      opacity: .95;
      white-space:nowrap;
    }
    .pillMini.real{ border-color: rgba(34,211,238,.28); background: rgba(34,211,238,.10); }
    .pillMini.staged{ border-color: rgba(244,114,182,.25); background: rgba(244,114,182,.08); }
    .marketLegend{
      display:flex;
      align-items:center;
      gap: 6px;
      margin-top: 10px;
      opacity: .9;
      flex-wrap: wrap;
    }
    .legendDot{
      width: 10px; height: 10px; border-radius: 999px; display:inline-block;
      border: 1px solid rgba(148,163,184,.35);
      background: rgba(148,163,184,.15);
    }
    .legendDot.real{ border-color: rgba(34,211,238,.45); background: rgba(34,211,238,.18); }
    .legendDot.staged{ border-color: rgba(244,114,182,.38); background: rgba(244,114,182,.14); }
</style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="title">
          OFF / Tangent ‚Äî ‚ÄúGrand Victory Run‚Äù Demo
          <span class="tag">v0.453</span>
        </div>
        <div class="subtitle">
          Real API flow with pillar lights: Health ‚Ä¢ Auth Spoof-Proof ‚Ä¢ Idempotency ‚Ä¢ Persistence.
        </div>
      </div>

      <div class="topbar">
        <div class="statusbar" role="status" aria-live="polite">
          <div class="dot" id="healthDot"></div>
          <div class="statusText">
            <strong id="healthLabel">Backend</strong>
            <span id="healthDetail">Not checked yet</span>
          </div>
          <button id="btnHealth" class="primary" type="button">Check</button>
        </div>

        <button id="btnVictory" class="primary" type="button">üèÅ Grand Victory Run</button>
        <button id="btnReset" class="danger" type="button">Reset</button>
        <button id="btnUnlock" type="button">Unlock UI</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Story -->
      <section class="card">
        <div class="cardHeader">
          <h2>Run Lane</h2>
          <div class="tiny">Watch it happen. Real requests. Clean logs.</div>
        </div>
        <div class="cardBody">
          <div class="stageTitle">
            <div class="pill" id="stagePill">idle</div>
            <div class="tiny" id="stageMeta">‚Äî</div>
          </div>

          <div class="pillars">
            <div class="pillar">
              <div class="dot" id="pHealth"></div>
              <div>
                <strong>Health</strong>
                <span id="pHealthTxt">Not checked</span>
              </div>
            </div>
            <div class="pillar">
              <div class="dot" id="pAuth"></div>
              <div>
                <strong>Auth spoof-proof</strong>
                <span id="pAuthTxt">Not verified</span>
              </div>
            </div>
            <div class="pillar">
              <div class="dot" id="pIdem"></div>
              <div>
                <strong>Idempotency</strong>
                <span id="pIdemTxt">Not tested</span>
              </div>
            </div>
            <div class="pillar">
              <div class="dot" id="pPersist"></div>
              <div>
                <strong>Persistence</strong>
                <span id="pPersistTxt">Not verified</span>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="lane" id="lane"></div>

          <div class="notice tiny" style="margin-top:10px;">
            Tip: leave ‚ÄúActor ID‚Äù blank ‚Äî auth should derive it from the key now. Spoof header is injected during the run to prove it‚Äôs ignored.
          </div>
        </div>
      </section>

      <!-- RIGHT: Config + Telemetry -->
      <section class="card">
        <div class="cardHeader">
          <h2>Config & Telemetry</h2>
          <div class="tiny">Paste keys. Save. Demo safely.</div>
        </div>
        <div class="cardBody">
          <div class="row2">
            <div>
              <label for="baseUrl">Backend Base URL</label>
              <input id="baseUrl" placeholder="https://off-backend.onrender.com" />
            </div>
            <div>
              <label for="demoSpeed">Demo Speed</label>
              <select id="demoSpeed">
                <option value="fast">Fast</option>
                <option value="demo" selected>Demo</option>
                <option value="slow">Slow</option>
              </select>
            </div>
          </div>

          <div class="row2">
            <div>
              <div class="labelRow">
                <div class="labelLeft">
                  <span class="keyDot warn" id="dotAdmin"></span>
                  <span>Admin API Key</span>
                </div>
                <button id="toggleAdmin" class="ghost" type="button">Show</button>
              </div>
              <input id="adminKey" type="password" placeholder="off_admin_key_‚Ä¶" autocomplete="off" />
            </div>

            <div>
              <div class="labelRow">
                <div class="labelLeft">
                  <span class="keyDot warn" id="dotGuest"></span>
                  <span>Guest API Key</span>
                </div>
                <button id="toggleGuest" class="ghost" type="button">Show</button>
              </div>
              <input id="guestKey" type="password" placeholder="off_guest_key_‚Ä¶" autocomplete="off" />
            </div>
          </div>

          <div class="row2">
            <div>
              <div class="labelRow">
                <div class="labelLeft">
                  <span class="keyDot warn" id="dotConc"></span>
                  <span>Concierge API Key</span>
                </div>
                <button id="toggleConc" class="ghost" type="button">Show</button>
              </div>
              <input id="concKey" type="password" placeholder="off_concierge_key_‚Ä¶" autocomplete="off" />
              <div class="tiny" style="margin-top:6px;">Keys auto-mask on save/load.</div>
            </div>

            <div>
              <label for="actorId">Actor ID (optional override)</label>
              <input id="actorId" placeholder="(leave empty)" />
            </div>
          </div>

          <div class="row2">
            <div>
              <label for="guestId">Guest ID</label>
              <input id="guestId" placeholder="guest_seed" />
            </div>
            <div>
              <label for="conciergeId">Concierge ID</label>
              <input id="conciergeId" placeholder="concierge_seed" />
            </div>
          </div>

          <div class="row2">
            <div>
              <label for="intent">Signal intent</label>
              <input id="intent" placeholder="coffee_walk" />
            </div>
            <div>
              <label for="location">Location</label>
              <input id="location" placeholder="UWS" />
            </div>
          </div>

          <div class="row2">
            <div>
              <label for="offerMsg">Offer message</label>
              <input id="offerMsg" placeholder="smoke offer" />
            </div>
            <div>
              <label for="offerPrice">Offer price (optional)</label>
              <input id="offerPrice" inputmode="numeric" placeholder="" />
            </div>
          </div>


          <div class="marketplace" id="marketplace">
            <div class="marketTop">
              <div>
                <div class="marketTitle">Offer Marketplace <span class="badge">demo</span></div>
                <div class="tiny">
                  This selection UI is <b>staged</b> for demo. When real offers exist, we show them live from the backend.
                </div>
              </div>
              <div class="marketMeta">
                <div class="tiny"><span class="kbd">Real</span> = GET /offers ‚Ä¢ <span class="kbd">Staged</span> = demo tiles</div>
                <div class="tiny">Selection: <span id="marketChoice" class="kbd">‚Äî</span></div>
              </div>
            </div>

            <div class="marketSections">
              <div class="marketSection">
                <div class="marketSectionTitle">Real offers (backend)</div>
                <div class="tiny">Loaded automatically during Run after the signal is created.</div>
                <div class="marketGrid" id="realOffers"></div>
              </div>

              <div class="marketSection">
                <div class="marketSectionTitle">Marketplace tiles (staged)</div>
                <div class="tiny">Used as a fallback when no real offers exist (or to seed one with the Admin key).</div>
                <div class="marketGrid" id="stagedOffers"></div>
              </div>
            </div>

            <div class="marketLegend">
              <span class="legendDot real"></span><span class="tiny">Real offer</span>
              <span style="width:12px"></span>
              <span class="legendDot staged"></span><span class="tiny">Staged offer</span>
              <span style="width:12px"></span>
              <span class="tiny">Tip: during Run, click a tile within 2.5s to override the auto-pick.</span>
            </div>
          </div>

          <div class="row2">
            <div>
              <label for="msgText">Message text</label>
              <input id="msgText" placeholder="hello from guest" />
            </div>
            <div>
              <label for="limit">Messages limit</label>
              <input id="limit" inputmode="numeric" placeholder="20" />
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button id="btnSave" type="button">Save</button>
            <button id="btnLoad" type="button">Load</button>
            <button id="btnClear" class="danger" type="button">Clear</button>
            <button id="btnCopyLog" type="button">Copy Log</button>
          </div>

          <div class="divider"></div>

          <div class="terminal">
            <div class="terminalTop">
              <div class="dots" aria-hidden="true"><span></span><span></span><span></span></div>
              <div class="terminalMeta">
                <span id="runState">idle</span>
                <span>‚Ä¢</span>
                <span id="lastReq">‚Äî</span>
              </div>
            </div>
            <div class="log" id="log"></div>
          </div>

          <div class="tiny" style="margin-top:10px;">
            If anything looks stuck: hit <span class="kbd">Unlock UI</span>.
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
(function(){
  const $ = (id) => document.getElementById(id);

  // --- UI helpers ---
  function setDot(elId, state){
    const el = $(elId);
    if (!el) return;
    el.classList.remove("good","warn","bad");
    if (state === "good") el.classList.add("good");
    else if (state === "warn") el.classList.add("warn");
    else if (state === "bad") el.classList.add("bad");
  }

  function logLine(text, cls="muted"){
    const logEl = $("log");
    const span = document.createElement("span");
    span.className = cls;
    span.textContent = text + "\n";
    logEl.appendChild(span);
    logEl.scrollTop = logEl.scrollHeight;
  }

  function clearLog(){ $("log").innerHTML = ""; }
  function clearLane(){ $("lane").innerHTML = ""; }

  function mkStoryCard(title, badgeText, badgeClass, innerHtml){
    const lane = $("lane");
    const div = document.createElement("div");
    div.className = "storyCard";
    div.innerHTML = `
      <div class="storyTop">
        <strong>${escapeHtml(title)}</strong>
        <span class="badge ${badgeClass || ""}">${escapeHtml(badgeText || "")}</span>
      </div>
      <div>${innerHtml}</div>
    `;
    lane.appendChild(div);
    lane.scrollTop = lane.scrollHeight;
    return div;
  }

  function kvHtml(pairs){
    return `
      <div class="kv">
        ${pairs.map(([k,v]) => `<b>${escapeHtml(k)}</b><div>${v}</div>`).join("")}
      </div>
    `;
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function fmtId(id){
    if (!id) return "‚Äî";
    const s = String(id);
    return s.length > 28 ? (s.slice(0, 12) + "‚Ä¶" + s.slice(-10)) : s;
  }

  function demoDelayMode(){
    const mode = $("demoSpeed").value;
    if (mode === "fast") return { step: 120, between: 180 };
    if (mode === "slow") return { step: 520, between: 560 };
    return { step: 260, between: 320 };
  }

  function updateRunState(s){ $("runState").textContent = s; }
  function setStage(stage, meta=""){ $("stagePill").textContent = stage; $("stageMeta").textContent = meta || "‚Äî"; }

  function normalizeBaseUrl(url){
    const u = (url || "").trim();
    if (!u) return "https://off-backend.onrender.com";
    return u.replace(/\/+$/,"");
  }

  function bearerHeader(token){
    const t = (token || "").trim();
    if (!t) return null;
    return t.toLowerCase().startsWith("bearer ") ? t : ("Bearer " + t);
  }

  // --- Key dots ---
  function keyHasValue(v){ return !!String(v || "").trim(); }
  function setKeyDot(which, state){
    const el = $(which);
    if (!el) return;
    el.classList.remove("good","warn","bad");
    if (state === "good") el.classList.add("good");
    else if (state === "warn") el.classList.add("warn");
    else if (state === "bad") el.classList.add("bad");
  }
  function refreshKeyDots(){
    setKeyDot("dotAdmin", keyHasValue($("adminKey").value) ? "good" : "warn");
    setKeyDot("dotGuest", keyHasValue($("guestKey").value) ? "good" : "warn");
    setKeyDot("dotConc",  keyHasValue($("concKey").value)  ? "good" : "warn");
  }

  function forceMaskKeys(){
    ["adminKey","guestKey","concKey"].forEach(id => { const input = $(id); if (input) input.type = "password"; });
    ["toggleAdmin","toggleGuest","toggleConc"].forEach(id => { const btn = $(id); if (btn) btn.textContent = "Show"; });
  }

  function toggleReveal(inputId, btnId){
    const input = $(inputId);
    const btn = $(btnId);
    if (!input || !btn) return;
    if (input.type === "password"){ input.type = "text"; btn.textContent = "Hide"; }
    else { input.type = "password"; btn.textContent = "Show"; }
  }

  // --- Persisted UI state ---
  function defaultState(){
    return {
      baseUrl: "https://off-backend.onrender.com",
      adminKey: "",
      guestKey: "",
      concKey: "",
      actorId: "",
      guestId: "guest_seed",
      conciergeId: "concierge_seed",
      intent: "coffee_walk",
      location: "UWS",
      offerMsg: "smoke offer",
      offerPrice: "",
      msgText: "hello from guest",
      limit: "20",
      demoSpeed: "demo"
    };
  }

  function readInputs(){
    return {
      baseUrl: $("baseUrl").value,
      adminKey: $("adminKey").value,
      guestKey: $("guestKey").value,
      concKey: $("concKey").value,
      actorId: $("actorId").value,
      guestId: $("guestId").value || "guest_seed",
      conciergeId: $("conciergeId").value || "concierge_seed",
      intent: $("intent").value || "coffee_walk",
      location: $("location").value || "UWS",
      offerMsg: $("offerMsg").value || "smoke offer",
      offerPrice: $("offerPrice").value || "",
      msgText: $("msgText").value || "hello from guest",
      limit: $("limit").value || "20",
      demoSpeed: $("demoSpeed").value || "demo"
    };
  }

  function applyInputs(st){
    $("baseUrl").value = st.baseUrl ?? "";
    $("adminKey").value = st.adminKey ?? "";
    $("guestKey").value = st.guestKey ?? "";
    $("concKey").value  = st.concKey ?? "";
    $("actorId").value  = st.actorId ?? "";
    $("guestId").value  = st.guestId ?? "";
    $("conciergeId").value = st.conciergeId ?? "";
    $("intent").value = st.intent ?? "";
    $("location").value = st.location ?? "";
    $("offerMsg").value = st.offerMsg ?? "";
    $("offerPrice").value = st.offerPrice ?? "";
    $("msgText").value = st.msgText ?? "";
    $("limit").value = st.limit ?? "20";
    $("demoSpeed").value = st.demoSpeed ?? "demo";
    refreshKeyDots();
    forceMaskKeys();
  }

  function saveState(){
    localStorage.setItem("off_demo_state_v453", JSON.stringify(readInputs()));
    forceMaskKeys();
    refreshKeyDots();
    logLine("[ui] saved state", "accent");
  }
  function loadState(){
    const raw = localStorage.getItem("off_demo_state_v453");
    if (!raw) { logLine("[ui] nothing saved yet", "warn"); refreshKeyDots(); return; }
    try { applyInputs(JSON.parse(raw)); logLine("[ui] loaded state", "accent"); }
    catch { logLine("[ui] save corrupt", "bad"); refreshKeyDots(); }
  }
  function clearState(){
    localStorage.removeItem("off_demo_state_v453");
    applyInputs(defaultState());
    forceMaskKeys();
    refreshKeyDots();
    logLine("[ui] cleared state", "warn");
  }

  // --- API ---
  async function apiFetch(path, { token, method="GET", body=null, idemKey=null, actorId=null, spoofActorId=null } = {}){
    const baseUrl = normalizeBaseUrl($("baseUrl").value);
    const url = baseUrl + path;

    const headers = { "Accept":"application/json" };
    const auth = bearerHeader(token);
    if (auth) headers["Authorization"] = auth;
    if (idemKey) headers["Idempotency-Key"] = idemKey;

    // Optional: real actor override (rare). Optional spoof to prove it‚Äôs ignored.
    if (actorId) headers["X-Actor-Id"] = actorId;
    if (spoofActorId) headers["X-Actor-Id"] = spoofActorId;

    if (body !== null) headers["Content-Type"] = "application/json";

    const res = await fetch(url, { method, headers, body: body !== null ? JSON.stringify(body) : undefined });
    const replay = res.headers.get("idempotency-replay");
    const reqId = res.headers.get("x-request-id");
    const ct = res.headers.get("content-type") || "";

    let data = null;
    if (ct.includes("application/json")) data = await res.json().catch(()=>null);
    else data = { raw: await res.text().catch(()=> "") };

    return { ok: res.ok, status: res.status, replay, reqId, data, url };
  }


  // --- Marketplace (staged + real offers) ---
  const MARKET = {
    choice: null, // { kind: "real", offer } or { kind:"staged", template }
    resolver: null
  };

  function stagedOfferTemplates({ guestId, conciergeId, intent, location }){
    const loc = (location || "nearby").trim() || "nearby";
    const it = (intent || "a moment").trim() || "a moment";

    return [
      {
        kind: "human",
        title: "Human: Coffee walk + micro-reset",
        description: `A calm 25‚Äì35 min walk in ${loc} with a concierge who keeps it simple. ‚ÄúLet‚Äôs get you back into the day.‚Äù`,
        price: 0,
        payload: { guest_id: guestId, concierge_id: conciergeId, message: "Coffee walk + micro-reset" }
      },
      {
        kind: "human",
        title: "Human: Quiet museum loop",
        description: `A low-stimulation loop: one room, one piece, one thought. Designed for rapid nervous-system downshift.`,
        price: 12,
        payload: { guest_id: guestId, concierge_id: conciergeId, message: "Quiet museum loop" }
      },
      {
        kind: "store",
        title: "Store: Borrowed book + reading nook",
        description: `A small ‚Äúoffline kit‚Äù: a library pickup + a mapped reading corner. Minimal friction, maximal calm.`,
        price: 0,
        payload: { guest_id: guestId, concierge_id: conciergeId, message: "Borrowed book + reading nook" }
      },
      {
        kind: "store",
        title: "Store: Hot chocolate + window seat",
        description: `A tiny ritual: hot drink + a ‚Äúwindow seat‚Äù spot. Simple sensory reset.`,
        price: 6,
        payload: { guest_id: guestId, concierge_id: conciergeId, message: "Hot chocolate + window seat" }
      },
      {
        kind: "ai",
        title: "AI: OFF itinerary (2 steps)",
        description: `An AI-crafted two-step micro-plan for ‚Äú${it}‚Äù near ${loc}, with an optional human add-on.`,
        price: 0,
        payload: { guest_id: guestId, concierge_id: conciergeId, message: "AI itinerary (2 steps) + optional human add-on" }
      },
      {
        kind: "ai",
        title: "AI: 10-minute reset protocol",
        description: `A compact script: breathe + walk + notice. Think of it as ‚Äúoffline guidance in your pocket.‚Äù`,
        price: 0,
        payload: { guest_id: guestId, concierge_id: conciergeId, message: "AI 10-minute reset protocol" }
      }
    ];
  }

  function setMarketChoiceLabel(text){
    const el = $("marketChoice");
    if (el) el.textContent = text || "‚Äî";
  }

  function clearMarketSelection(){
    MARKET.choice = null;
    setMarketChoiceLabel("‚Äî");
    document.querySelectorAll(".offerTile.selected").forEach(el => el.classList.remove("selected"));
  }

  function renderOfferTiles(containerId, items, kind){
    const root = $(containerId);
    root.innerHTML = "";

    if (!items || items.length === 0){
      root.innerHTML = `<div class="tiny" style="opacity:.8;">No ${kind === "real" ? "real offers yet." : "staged tiles loaded."}</div>`;
      return;
    }

    items.forEach((item, idx) => {
      const isReal = kind === "real";
      const kickerLeft = isReal ? "REAL (backend)" : "STAGED (demo)";
      const pill = isReal ? "real" : "staged";
      const title = isReal ? (item.title || ("Offer " + (idx+1))) : item.title;
      const desc  = isReal ? (item.description || item.message || "") : item.description;
      const price = isReal ? (item.price ?? item.price_cents ?? item.price_cents_total ?? null) : item.price;
      const priceTxt = (price === null || price === undefined || price === "") ? "" : (Number(price) === 0 ? "‚Ä¢ $0" : `‚Ä¢ $${Number(price)}`);

      const el = document.createElement("div");
      el.className = "offerTile";
      el.dataset.kind = kind;
      el.dataset.idx = String(idx);

      el.innerHTML = `
        <div class="kicker">
          <span class="pillMini ${pill}">${kickerLeft}</span>
          <span class="tiny" style="opacity:.85;">${isReal ? escapeHtml(item.id || "") : escapeHtml(item.kind.toUpperCase())} ${escapeHtml(priceTxt)}</span>
        </div>
        <div class="title">${escapeHtml(title)}</div>
        <div class="desc">${escapeHtml(desc || "")}</div>
      `;

      el.addEventListener("click", () => {
        document.querySelectorAll(`#${containerId} .offerTile`).forEach(x => x.classList.remove("selected"));
        el.classList.add("selected");

        if (isReal){
          MARKET.choice = { kind: "real", offer: item };
          setMarketChoiceLabel(item.id ? `real:${fmtId(item.id)}` : "real:selected");
        } else {
          MARKET.choice = { kind: "staged", template: item };
          setMarketChoiceLabel(`staged:${item.kind}`);
        }

        if (MARKET.resolver){
          const r = MARKET.resolver;
          MARKET.resolver = null;
          r(MARKET.choice);
        }
      });

      root.appendChild(el);
    });
  }

  async function fetchRealOffersForSignal(signalId, guestToken, actorId){
    if (!signalId) return [];
    const qs = encodeURIComponent(signalId);
    const resp = await apiFetch(`/offers?signal_id=${qs}`, {
      token: guestToken,
      method: "GET",
      actorId: actorId
    });
    if (!resp.ok) return [];
    const items = resp.data?.items || [];
    return Array.isArray(items) ? items : [];
  }

  async function awaitMarketplaceSelection({ realOffers, stagedOffers, timeoutMs=2500 }){
    clearMarketSelection();
    renderOfferTiles("realOffers", realOffers, "real");
    renderOfferTiles("stagedOffers", stagedOffers, "staged");

    if (realOffers && realOffers.length){
      const first = realOffers[0];
      MARKET.choice = { kind:"real", offer:first };
      setMarketChoiceLabel(first.id ? `real:${fmtId(first.id)}` : "real:auto");
      const firstEl = document.querySelector("#realOffers .offerTile");
      if (firstEl) firstEl.classList.add("selected");
    } else if (stagedOffers && stagedOffers.length){
      const first = stagedOffers[0];
      MARKET.choice = { kind:"staged", template:first };
      setMarketChoiceLabel(`staged:${first.kind} (auto)`);
      const firstEl = document.querySelector("#stagedOffers .offerTile");
      if (firstEl) firstEl.classList.add("selected");
    }

    return await new Promise(resolve => {
      MARKET.resolver = resolve;
      setTimeout(() => {
        if (MARKET.resolver){
          MARKET.resolver = null;
          resolve(MARKET.choice);
        }
      }, timeoutMs);
    });
  }

  // --- Health ---
  async function checkHealth(){
    $("healthDetail").textContent = "Checking‚Ä¶";
    setDot("healthDot","warn");
    setDot("pHealth","warn");
    $("pHealthTxt").textContent = "Checking‚Ä¶";

    const baseUrl = normalizeBaseUrl($("baseUrl").value);
    const started = performance.now();
    try{
      const res = await fetch(baseUrl + "/health", { method:"GET" });
      const ms = Math.round(performance.now() - started);
      if (!res.ok){
        setDot("healthDot","bad");
        setDot("pHealth","bad");
        $("healthDetail").textContent = `HTTP ${res.status} ‚Ä¢ ${ms}ms`;
        $("pHealthTxt").textContent = `HTTP ${res.status}`;
        return false;
      }
      const data = await res.json().catch(()=> ({}));
      setDot("healthDot","good");
      setDot("pHealth","good");
      $("healthDetail").textContent = `ok ‚Ä¢ ${ms}ms ‚Ä¢ uptime ${Math.round(data.uptime||0)}s`;
      $("pHealthTxt").textContent = `ok ‚Ä¢ ${ms}ms`;
      return true;
    } catch {
      setDot("healthDot","bad");
      setDot("pHealth","bad");
      $("healthDetail").textContent = "unreachable";
      $("pHealthTxt").textContent = "unreachable";
      return false;
    }
  }

  // --- Run flow ---
  let uiLocked = false;
  function lockUi(lock){
    uiLocked = !!lock;
    ["btnVictory","btnReset","btnHealth"].forEach(id => { $(id).disabled = uiLocked; });
  }
  function hardUnlock(){
    lockUi(false);
    setStage("idle","Unlocked");
    updateRunState("idle");
    logLine("[ui] hard unlock", "warn");
  }

  function resetUi(){
    clearLane();
    clearLog();
    setStage("idle","Ready");
    updateRunState("idle");
    setDot("pAuth","warn"); $("pAuthTxt").textContent = "Not verified";
    setDot("pIdem","warn"); $("pIdemTxt").textContent = "Not tested";
    setDot("pPersist","warn"); $("pPersistTxt").textContent = "Not verified";
    logLine("[ui] reset", "warn");
  }

  async function grandVictoryRun(){
    clearLane();
    clearLog();

    setStage("starting","Booting engines‚Ä¶");
    updateRunState("running");
    lockUi(true);

    // reset pillar lights
    setDot("pAuth","warn"); $("pAuthTxt").textContent = "Running check‚Ä¶";
    setDot("pIdem","warn"); $("pIdemTxt").textContent = "Running check‚Ä¶";
    setDot("pPersist","warn"); $("pPersistTxt").textContent = "Running check‚Ä¶";

    const st = readInputs();
    const { step, between } = demoDelayMode();

    const actorOverride = (st.actorId || "").trim() || null;
    const guestId = (st.guestId || "guest_seed").trim();
    const conciergeId = (st.conciergeId || "concierge_seed").trim();

    try{
      // 0) Health
      logLine("== 0) Health ==", "accent");
      const okHealth = await checkHealth();
      if (!okHealth){
        mkStoryCard("Backend unreachable", "error", "bad", `<div class="tiny">Fix base URL / Render deploy, then re-run.</div>`);
        setStage("error","Health failed");
        updateRunState("error");
        return;
      }
      await sleep(between);

      // 1) Create signal (guest)
      setStage("signal","Creating signal‚Ä¶");
      logLine("", "muted");
      logLine("== 1) POST /signals (guest) ==", "accent");
      const sigKey = "ui-signal-" + Date.now();
      const sigResp = await apiFetch("/signals", {
        token: st.guestKey,
        method: "POST",
        idemKey: sigKey,
        actorId: actorOverride,
        body: { guest_id: guestId, intent: st.intent.trim(), location: st.location.trim() }
      });

      $("lastReq").textContent = sigResp.reqId || "‚Äî";
      if (!sigResp.ok){
        mkStoryCard("Signal failed", "error", "bad", `<div class="tiny">HTTP ${sigResp.status}</div><pre class="tiny">${escapeHtml(JSON.stringify(sigResp.data, null, 2))}</pre>`);
        setStage("error","Signal failed");
        updateRunState("error");
        return;
      }

      const signal = sigResp.data?.signal;
      mkStoryCard("Signal created", "real", "good",
        kvHtml([
          ["signal_id", `<span class="kbd">${escapeHtml(fmtId(signal?.id))}</span>`],
          ["guest_id", escapeHtml(signal?.guest_id || guestId)],
          ["intent", `<b>${escapeHtml(signal?.intent || "")}</b>`],
          ["location", escapeHtml(signal?.location || "")]
        ])
      );

      const persistedSignal = sigResp.data?.persisted === true;
      if (persistedSignal){
        setDot("pPersist","good"); $("pPersistTxt").textContent = "persisted=true observed";
      } else {
        setDot("pPersist","warn"); $("pPersistTxt").textContent = "persisted not confirmed yet";
      }

      await sleep(between);

      // 2) Offer marketplace (REAL if available; otherwise staged tiles)
      setStage("offer","Selecting offer‚Ä¶");
      logLine("", "muted");
      logLine("== 2) OFFER MARKETPLACE ==", "accent");

      const realOffers = await fetchRealOffersForSignal(signal.id, st.guestKey, actorOverride);
      const staged = stagedOfferTemplates({ guestId, conciergeId, intent, location });

      const choice = await awaitMarketplaceSelection({ realOffers, stagedOffers: staged, timeoutMs: 2500 });

      let offer = null;

      if (choice?.kind === "real" && choice.offer?.id){
        offer = choice.offer;
        mkStoryCard("Offer selected", "pass", "good",
          kvHtml([
            ["mode", "<b>real (backend)</b>"],
            ["offer_id", `<span class="kbd">${escapeHtml(String(offer.id))}</span>`],
            ["status", `<b>${escapeHtml(offer.status || "proposed")}</b>`]
          ])
        );
      } else {
        if (!st.adminKey || String(st.adminKey).trim().length < 8){
          mkStoryCard("Offer required", "error", "bad",
            "No real offers exist for this signal yet, and the Admin API key is missing ‚Äî so the demo cannot seed an offer. Add the Admin key and re-run."
          );
          throw new Error("ADMIN_KEY_REQUIRED_FOR_OFFER_SEED");
        }

        setStage("offer","Creating offer‚Ä¶");
        logLine("", "muted");
        logLine("== 2B) POST /offers (admin) ‚Äî seed from staged selection ==", "accent");

        const offerKey = "ui-offer-" + Date.now();
        const tpl = choice?.template || staged[0];

        const offBody = {
          signal_id: signal.id,
          guest_id: guestId,
          concierge_id: conciergeId,
          message: (tpl?.payload?.message || st.offerMsg || "").trim()
        };

        const price = (tpl?.price !== undefined && tpl?.price !== null) ? tpl.price : st.offerPrice;
        if (String(price || "").trim() !== "" && Number.isFinite(Number(price))) offBody.price = Number(price);

        const offerResp = await apiFetch("/offers", {
          token: st.adminKey,
          method: "POST",
          idemKey: offerKey,
          actorId: actorOverride,
          body: offBody
        });

        $("lastReq").textContent = offerResp.reqId || "‚Äî";
        if (!offerResp.ok){
          mkStoryCard("Offer failed", "error", "bad",
            (offerResp.data?.message || offerResp.data?.error || "Offer creation failed.")
          );
          throw new Error("OFFER_CREATE_FAILED");
        }

        offer = offerResp.data?.offer || offerResp.data?.item || offerResp.data?.data || offerResp.data?.result || null;

        mkStoryCard("Offer created", "pass", "good",
          kvHtml([
            ["mode", "<b>staged (demo) ‚Üí real POST</b>"],
            ["offer_id", `<span class="kbd">${escapeHtml(String(offer?.id || ""))}</span>`],
            ["signal_id", `<span class="kbd">${escapeHtml(String(signal.id))}</span>`]
          ])
        );

        const persistedOffer = offerResp.data?.persisted === true;
        if (persistedOffer){
          setDot("pPersist","good"); $("pPersistTxt").textContent = "persisted=true observed";
        }

        await sleep(between);

        // Refresh real offers list after seeding (nice for demo)
        const after = await fetchRealOffersForSignal(signal.id, st.guestKey, actorOverride);
        renderOfferTiles("realOffers", after, "real");
      }

      await sleep(between);

      // 3) Accept offer (guest) ‚Äî run twice with same idem key to verify replay

      // 3) Accept offer (guest) ‚Äî run twice with same idem key to verify replay
      setStage("accept","Accepting offer‚Ä¶");
      logLine("", "muted");
      logLine("== 3) POST /offers/:id/accept (guest) ‚Äî FIRST ==", "accent");

      const acceptKey = "ui-accept-" + Date.now();
      const acc1 = await apiFetch(`/offers/${encodeURIComponent(offer.id)}/accept`, {
        token: st.guestKey,
        method: "POST",
        idemKey: acceptKey,
        actorId: actorOverride,
        body: {}
      });

      $("lastReq").textContent = acc1.reqId || "‚Äî";
      if (!acc1.ok){
        mkStoryCard("Accept failed", "error", "bad", `<div class="tiny">HTTP ${acc1.status}</div><pre class="tiny">${escapeHtml(JSON.stringify(acc1.data, null, 2))}</pre>`);
        setStage("error","Accept failed");
        updateRunState("error");
        return;
      }

      mkStoryCard("Offer accepted", "real", "good",
        kvHtml([
          ["idempotency", `<span class="kbd">${escapeHtml(acc1.replay ? "replayed" : "fresh")}</span>`],
          ["status", `<b>${escapeHtml(acc1.data?.offer?.status || acc1.data?.offer?.status || "accepted")}</b>`]
        ])
      );

      await sleep(step);

      logLine("== 4) POST /offers/:id/accept (guest) ‚Äî REPLAY (same key) ==", "accent");
      const acc2 = await apiFetch(`/offers/${encodeURIComponent(offer.id)}/accept`, {
        token: st.guestKey,
        method: "POST",
        idemKey: acceptKey,
        actorId: actorOverride,
        body: {}
      });

      $("lastReq").textContent = acc2.reqId || "‚Äî";
      const idemOk = (String(acc2.replay || "").toLowerCase() === "true") || (acc2.data?.idempotency?.replayed === true);
      if (idemOk){
        setDot("pIdem","good"); $("pIdemTxt").textContent = "replay=true confirmed";
      } else {
        setDot("pIdem","warn"); $("pIdemTxt").textContent = "replay not confirmed (check headers)";
      }

      mkStoryCard("Idempotency check", idemOk ? "pass" : "check", idemOk ? "good" : "warn",
        kvHtml([
          ["replay header", escapeHtml(String(acc2.replay ?? "‚Äî"))],
          ["request_id", `<span class="kbd">${escapeHtml(fmtId(acc2.reqId || ""))}</span>`]
        ])
      );

      // Persistence can be re-confirmed here too
      if (acc1.data?.persisted === true || acc2.data?.persisted === true){
        setDot("pPersist","good"); $("pPersistTxt").textContent = "persisted=true observed";
      }

      await sleep(between);

      // 5) Create vibe (guest)
      setStage("vibe","Creating vibe‚Ä¶");
      logLine("", "muted");
      logLine("== 5) POST /vibes (guest) ==", "accent");

      const vibeId = "vib_ui_" + Date.now();
      const vibeKey = "ui-vibe-" + Date.now();
      const vibeResp = await apiFetch("/vibes", {
        token: st.guestKey,
        method: "POST",
        idemKey: vibeKey,
        actorId: actorOverride,
        body: {
          id: vibeId,
          signal_id: signal.id,
          guest_id: guestId,
          concierge_id: conciergeId
        }
      });

      $("lastReq").textContent = vibeResp.reqId || "‚Äî";
      if (!vibeResp.ok){
        mkStoryCard("Vibe failed", "error", "bad", `<div class="tiny">HTTP ${vibeResp.status}</div><pre class="tiny">${escapeHtml(JSON.stringify(vibeResp.data, null, 2))}</pre>`);
        setStage("error","Vibe failed");
        updateRunState("error");
        return;
      }

      const vibe = vibeResp.data?.vibe;
      mkStoryCard("Vibe created", "real", "good",
        kvHtml([
          ["vibe_id", `<span class="kbd">${escapeHtml(fmtId(vibe?.external_id || vibeId))}</span>`],
          ["guest_id", escapeHtml(vibe?.guest_id || guestId)],
          ["concierge_id", escapeHtml(vibe?.concierge_id || conciergeId)],
          ["status", `<b>${escapeHtml(vibe?.status || "active")}</b>`]
        ])
      );

      await sleep(between);

      // 6) POST message (guest) with spoof header to prove it‚Äôs ignored
      setStage("message","Posting message (spoof test)‚Ä¶");
      logLine("", "muted");
      logLine("== 6) POST /messages (guest ‚Äî spoof header should be ignored) ==", "accent");

      const msgKey = "ui-msg-" + Date.now();
      const spoofActor = "evil_spoofer_" + Math.floor(Math.random()*1000);

      const msgResp = await apiFetch("/messages", {
        token: st.guestKey,
        method: "POST",
        idemKey: msgKey,
        actorId: actorOverride,
        spoofActorId: actorOverride ? null : spoofActor,
        body: { vibe_id: (vibe?.external_id || vibeId), text: st.msgText.trim() }
      });

      $("lastReq").textContent = msgResp.reqId || "‚Äî";
      if (!msgResp.ok){
        mkStoryCard("Message failed", "error", "bad", `<div class="tiny">HTTP ${msgResp.status}</div><pre class="tiny">${escapeHtml(JSON.stringify(msgResp.data, null, 2))}</pre>`);
        setStage("error","Message failed");
        updateRunState("error");
        return;
      }

      const msg = msgResp.data?.message;
      const derivedActor = msg?.actor_id;
      const spoofOk = actorOverride
        ? true
        : (derivedActor && derivedActor !== spoofActor);

      if (spoofOk){
        setDot("pAuth","good");
        $("pAuthTxt").textContent = actorOverride ? "override mode" : "spoof ignored ‚úî";
      } else {
        setDot("pAuth","bad");
        $("pAuthTxt").textContent = "spoof may not be ignored";
      }

      mkStoryCard("Message posted", "real", spoofOk ? "good" : "warn",
        kvHtml([
          ["spoof header", `<span class="kbd">${escapeHtml(actorOverride ? "(disabled)" : spoofActor)}</span>`],
          ["actor_id used", `<span class="kbd">${escapeHtml(derivedActor || "‚Äî")}</span>`],
          ["text", `<b>${escapeHtml(msg?.text || "")}</b>`]
        ])
      );

      await sleep(between);

      // 7) GET messages (guest)
      setStage("fetch","Fetching messages‚Ä¶");
      logLine("", "muted");
      logLine("== 7) GET /messages (guest) ==", "accent");

      const limit = Number(st.limit || "20");
      const get1 = await apiFetch(`/messages?vibe_id=${encodeURIComponent(vibe?.external_id || vibeId)}&limit=${encodeURIComponent(String(Number.isFinite(limit) ? limit : 20))}&offset=0`, {
        token: st.guestKey,
        method: "GET",
        actorId: actorOverride
      });

      $("lastReq").textContent = get1.reqId || "‚Äî";
      if (!get1.ok){
        mkStoryCard("Fetch (guest) failed", "error", "bad", `<div class="tiny">HTTP ${get1.status}</div><pre class="tiny">${escapeHtml(JSON.stringify(get1.data, null, 2))}</pre>`);
        setStage("error","Fetch failed");
        updateRunState("error");
        return;
      }

      // 8) GET messages (concierge)
      logLine("== 8) GET /messages (concierge) ==", "accent");
      const get2 = await apiFetch(`/messages?vibe_id=${encodeURIComponent(vibe?.external_id || vibeId)}&limit=${encodeURIComponent(String(Number.isFinite(limit) ? limit : 20))}&offset=0`, {
        token: st.concKey,
        method: "GET",
        actorId: actorOverride
      });

      $("lastReq").textContent = get2.reqId || "‚Äî";

      // Render chat
      const msgs = Array.isArray(get1.data?.messages) ? get1.data.messages : [];
      const chat = renderChat(msgs);

      mkStoryCard("Conversation", "real", "good",
        `<div class="tiny">guest sees ${escapeHtml(String(get1.data?.count ?? msgs.length))} ‚Ä¢ concierge sees ${escapeHtml(String(get2.data?.count ?? "‚Äî"))}</div>` +
        chat
      );

      // Persistence ‚Äústill good‚Äù if messages include created_at and API is returning
      if (msgs.length >= 1) {
        setDot("pPersist","good"); $("pPersistTxt").textContent = "read-after-write OK";
      }

      setStage("done","Grand Victory Run complete");
      updateRunState("done");
      logLine("", "muted");
      logLine("‚úÖ GRAND VICTORY RUN COMPLETE ‚Äî OFF backend looks elite", "good");
    } catch (e){
      setStage("error","Exception");
      updateRunState("error");
      logLine("[exception] " + String(e?.message || e), "bad");
    } finally {
      lockUi(false);
      refreshKeyDots();
      forceMaskKeys();
    }
  }

  function renderChat(messages){
    const items = (messages || []).map(m => {
      const role = (m.from_role === "concierge") ? "concierge" : "guest";
      const who = m.from_role || "guest";
      const time = m.created_at ? new Date(m.created_at).toLocaleTimeString() : "";
      return `
        <div class="bubble ${role}">
          ${escapeHtml(m.text || "")}
          <div class="bubbleMeta">${escapeHtml(who)} ${time ? "‚Ä¢ " + escapeHtml(time) : ""}</div>
        </div>
      `;
    }).join("");
    return `<div class="chat">${items || `<div class="tiny">No messages yet.</div>`}</div>`;
  }

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  // --- init ---
  function init(){
    applyInputs(defaultState());
    loadState();
    $("baseUrl").value = normalizeBaseUrl($("baseUrl").value);

    $("toggleAdmin").addEventListener("click", ()=>toggleReveal("adminKey","toggleAdmin"));
    $("toggleGuest").addEventListener("click", ()=>toggleReveal("guestKey","toggleGuest"));
    $("toggleConc").addEventListener("click",  ()=>toggleReveal("concKey","toggleConc"));

    ["adminKey","guestKey","concKey"].forEach(id=>{
      $(id).addEventListener("input", refreshKeyDots);
      $(id).addEventListener("blur", refreshKeyDots);
    });

    $("btnSave").addEventListener("click", saveState);
    $("btnLoad").addEventListener("click", loadState);
    $("btnClear").addEventListener("click", clearState);

    $("btnCopyLog").addEventListener("click", async () => {
      try { await navigator.clipboard.writeText($("log").innerText || ""); logLine("[ui] copied log", "good"); }
      catch { logLine("[ui] clipboard blocked", "warn"); }
    });

    $("btnHealth").addEventListener("click", checkHealth);
    $("btnVictory").addEventListener("click", grandVictoryRun);
    $("btnReset").addEventListener("click", resetUi);
    $("btnUnlock").addEventListener("click", hardUnlock);

    // periodic health check
    setInterval(() => { if (!document.hidden) checkHealth(); }, 30000);

    forceMaskKeys();
    refreshKeyDots();

    resetUi();
    checkHealth();
    logLine("[ui] ready v0.453", "muted");
  }

  init();
})();
</script>
</body>
</html>
