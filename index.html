<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OFF · Micro-experience console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #05060a;
      --bg-elevated: #10121a;
      --bg-elevated-softer: #151826;
      --border-subtle: #262b3d;
      --accent: #4f8dff;
      --accent-soft: rgba(79, 141, 255, 0.16);
      --accent-strong: #7db2ff;
      --danger: #ff5c7a;
      --text: #f5f7ff;
      --text-soft: #a8b0cc;
      --pill-bg: #1b1f30;
      --pill-border: #323852;
      --radius-lg: 18px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.45);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Inter", sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: var(--font-main);
      background: radial-gradient(circle at top, #12182a 0, #05060a 55%);
      color: var(--text);
      min-height: 100vh;
    }

    .page {
      max-width: 1120px;
      margin: 0 auto;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 8px 16px;
      align-items: baseline;
      margin-bottom: 16px;
    }

    header h1 {
      font-size: 26px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      margin: 0;
    }

    header h1 span {
      font-weight: 500;
      font-size: 14px;
      text-transform: none;
      color: var(--text-soft);
      display: block;
      margin-top: 4px;
    }

    .meta {
      text-align: right;
      font-size: 13px;
      color: var(--text-soft);
    }

    .meta strong {
      color: var(--accent-strong);
      font-weight: 500;
    }

    .mode-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
      justify-content: flex-end;
      font-size: 13px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--pill-border);
      background: var(--pill-bg);
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #2dd58c;
      box-shadow: 0 0 10px rgba(45, 213, 140, 0.8);
    }

    .mode-pill {
      display: inline-flex;
      padding: 3px;
      border-radius: var(--radius-pill);
      background: #070815;
      border: 1px solid var(--pill-border);
    }

    .mode-pill button {
      border: none;
      background: transparent;
      padding: 4px 12px;
      border-radius: var(--radius-pill);
      font-size: 12px;
      color: var(--text-soft);
      cursor: pointer;
    }

    .mode-pill button.active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.3);
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 18px;
    }

    @media (max-width: 880px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background: radial-gradient(circle at top left, #20263b 0, #10121a 48%, #05060a 100%);
      border-radius: 22px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      padding: 16px 16px 14px;
      position: relative;
      overflow: hidden;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(79, 141, 255, 0.16), transparent 55%);
      opacity: 0.65;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .panel-inner {
      position: relative;
      z-index: 1;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 10px;
    }

    .panel-title {
      font-size: 14px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .panel-title span {
      font-weight: 500;
      color: var(--text);
    }

    .badge {
      padding: 2px 10px;
      border-radius: var(--radius-pill);
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      border: 1px solid var(--pill-border);
      background: rgba(4, 7, 20, 0.9);
      color: var(--text-soft);
    }

    .badge.badge-guest {
      border-color: var(--accent-soft);
    }

    .badge.badge-concierge {
      border-color: rgba(45, 213, 140, 0.4);
    }

    .section-label {
      margin: 10px 0 4px;
      font-size: 13px;
      font-weight: 500;
    }

    .section-help {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 8px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-bottom: 10px;
    }

    .field label {
      font-size: 12px;
      color: var(--text-soft);
    }

    .field-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #2c3247;
      background: rgba(6, 8, 20, 0.9);
      color: var(--text);
      font-size: 13px;
      padding: 7px 9px;
      outline: none;
    }

    textarea {
      min-height: 62px;
      resize: vertical;
    }

    input::placeholder,
    textarea::placeholder {
      color: #636b8c;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px rgba(79, 141, 255, 0.6);
    }

    .pill-button {
      border-radius: var(--radius-pill);
      padding: 8px 16px;
      border: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .pill-primary {
      background: linear-gradient(135deg, var(--accent), #8f9bff);
      color: #fff;
      box-shadow: 0 8px 25px rgba(49, 104, 225, 0.7);
    }

    .pill-primary:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .pill-ghost {
      background: rgba(12, 14, 30, 0.9);
      border: 1px solid var(--border-subtle);
      color: var(--text-soft);
    }

    .pill-ghost:hover {
      border-color: var(--accent-soft);
      color: var(--accent-strong);
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
      margin-bottom: 6px;
    }

    .status-line {
      font-size: 12px;
      color: var(--text-soft);
      margin-top: 4px;
      min-height: 16px;
    }

    .status-line.ok {
      color: #55d69b;
    }

    .status-line.err {
      color: var(--danger);
    }

    .console-box {
      margin-top: 8px;
      border-radius: 12px;
      background: var(--bg-elevated-softer);
      border: 1px solid var(--border-subtle);
      padding: 8px;
      font-size: 12px;
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, monospace;
      color: #d7ddff;
      max-height: 280px;
      overflow: auto;
      white-space: pre;
    }

    .console-label {
      font-size: 11px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .tagline {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 6px;
    }

    .tagline strong {
      color: var(--accent-strong);
    }

    .health-pill {
      font-size: 11px;
      padding: 2px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--pill-border);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(6, 10, 26, 0.9);
    }

    .health-pill.ok {
      border-color: rgba(45, 213, 140, 0.6);
      color: #60e0a1;
    }

    .health-pill.err {
      border-color: rgba(255, 92, 122, 0.9);
      color: var(--danger);
    }

    .health-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
      box-shadow: 0 0 10px currentColor;
    }

    .console-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    .console-subtitle {
      font-size: 12px;
      color: var(--text-soft);
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div>
        <h1>
          OFF
          <span>Micro-experience console · prototype</span>
        </h1>
      </div>
      <div class="meta">
        <div>Frontend <strong>v0.45</strong> · Backend <strong>v0.448</strong> (in-memory)</div>
        <div class="mode-toggle">
          <span>Mode</span>
          <div class="mode-pill">
            <button id="mode-guest" class="active" type="button">Guest</button>
            <button id="mode-concierge" type="button">Concierge</button>
          </div>
          <span class="chip">
            <span class="chip-dot"></span>
            Ready ·
            <span style="color: var(--accent-strong)">https://off-backend.onrender.com</span>
          </span>
        </div>
      </div>
    </header>

    <main>
      <!-- Left column: guest / concierge workspace -->
      <section class="panel">
        <div class="panel-inner">
          <div class="panel-header">
            <div class="panel-title">
              Guest workspace <span>console</span>
            </div>
            <span class="badge badge-guest">guest</span>
          </div>

          <div id="guest-workspace">
            <div class="section-label">1. Send a signal</div>
            <div class="section-help">
              Create a signal and we’ll show how it flows into offers and vibes.
            </div>

            <div class="field">
              <label for="guest-id-input">Guest ID</label>
              <input id="guest-id-input" type="text" value="guest_abc" autocomplete="off" />
            </div>

            <div class="field">
              <label for="intent-input">What do you feel like doing?</label>
              <input
                id="intent-input"
                type="text"
                placeholder="e.g., sunrise coffee by the Hudson"
                autocomplete="off"
              />
            </div>

            <div class="field">
              <label for="location-input">Rough location (optional)</label>
              <input
                id="location-input"
                type="text"
                value="Upper West Side, NYC"
                autocomplete="off"
              />
            </div>

            <div class="section-help">
              OFF will eventually turn this into a simple, offline micro-experience.
            </div>

            <div class="button-row">
              <button id="send-signal-btn" class="pill-button pill-primary" type="button">
                Send signal
              </button>
            </div>

            <hr style="border:none;border-top:1px solid #262b3d;margin:10px 0 8px" />

            <div class="section-label">2. Your recent signals & vibes</div>
            <div class="section-help">
              Load a quick overview for this guest, including signals, offers and vibes.
            </div>

            <div class="button-row">
              <button id="refresh-guest-overview-btn" class="pill-button pill-ghost" type="button">
                Refresh guest overview
              </button>
            </div>

            <div id="guest-overview-status" class="status-line"></div>
          </div>

          <!-- concierge workspace (same panel, swapped by mode) -->
          <div id="concierge-workspace" style="display:none">
            <div class="panel-header" style="margin-top:-4px;margin-bottom:10px">
              <div class="panel-title">
                Concierge workspace <span>console</span>
              </div>
              <span class="badge badge-concierge">concierge</span>
            </div>

            <div class="field">
              <label for="concierge-id-input">Concierge ID</label>
              <input id="concierge-id-input" type="text" value="conc_demo" autocomplete="off" />
            </div>

            <div class="section-label">1. See pending signals</div>
            <div class="section-help">
              Pull a feed of pending guest signals. Later this becomes your matching inbox.
            </div>

            <div class="button-row">
              <button id="list-pending-btn" class="pill-button pill-ghost" type="button">
                List pending signals
              </button>
            </div>

            <div class="section-label">2. Make an offer</div>
            <div class="section-help">
              Create a prototype offer on a signal to simulate a micro-experience.
            </div>

            <div class="field">
              <label for="offer-signal-id-input">Signal ID</label>
              <input
                id="offer-signal-id-input"
                type="text"
                placeholder="Paste a signal id from the console"
                autocomplete="off"
              />
            </div>

            <div class="field-row">
              <div class="field" style="flex:1 1 120px; min-width:120px">
                <label for="offer-price-input">Price (optional)</label>
                <input
                  id="offer-price-input"
                  type="text"
                  placeholder="e.g., 20"
                  autocomplete="off"
                />
              </div>
            </div>

            <div class="field">
              <label for="offer-message-input">Offer message</label>
              <textarea
                id="offer-message-input"
                placeholder="e.g., I can host you at 7:15am near Riverside Park."
              ></textarea>
            </div>

            <div class="button-row">
              <button id="create-offer-btn" class="pill-button pill-primary" type="button">
                Create offer
              </button>
            </div>

            <div id="concierge-status" class="status-line"></div>
          </div>

          <p class="tagline">
            <strong>Today</strong> this is a debug console. <br />
            <span style="opacity:0.85">Soon it becomes a real OFF guest & concierge surface.</span>
          </p>
        </div>
      </section>

      <!-- Right column: activity / responses -->
      <section class="panel">
        <div class="panel-inner">
          <div class="panel-header">
            <div class="panel-title">
              Activity & responses <span>console</span>
            </div>
            <div class="console-header-row">
              <div class="console-subtitle">
                See raw JSON responses from the OFF backend as you click around.
              </div>
            </div>
          </div>

          <div class="console-header-row">
            <div class="console-label">Backend health</div>
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
              <div id="health-pill" class="health-pill err">
                <span class="health-dot"></span>
                <span id="health-text">Health check pending…</span>
              </div>
              <button id="retry-health-btn" class="pill-button pill-ghost" type="button">
                Retry health check
              </button>
            </div>
          </div>

          <div class="status-line" id="health-detail"></div>

          <div style="margin-top:10px">
            <div class="console-label">Last response</div>
            <div id="last-response-meta" class="status-line"></div>
            <div id="last-response-box" class="console-box">{}</div>
          </div>

          <div style="margin-top:10px">
            <div class="console-label">Messages / details (for current vibe or overview)</div>
            <div id="secondary-response-box" class="console-box">[]</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const API_BASE = "https://off-backend.onrender.com";

    const els = {
      modeGuest: document.getElementById("mode-guest"),
      modeConcierge: document.getElementById("mode-concierge"),
      guestWorkspace: document.getElementById("guest-workspace"),
      conciergeWorkspace: document.getElementById("concierge-workspace"),

      guestId: document.getElementById("guest-id-input"),
      intent: document.getElementById("intent-input"),
      location: document.getElementById("location-input"),

      sendSignalBtn: document.getElementById("send-signal-btn"),
      refreshGuestOverviewBtn: document.getElementById("refresh-guest-overview-btn"),
      guestOverviewStatus: document.getElementById("guest-overview-status"),

      conciergeId: document.getElementById("concierge-id-input"),
      listPendingBtn: document.getElementById("list-pending-btn"),
      offerSignalId: document.getElementById("offer-signal-id-input"),
      offerPrice: document.getElementById("offer-price-input"),
      offerMessage: document.getElementById("offer-message-input"),
      createOfferBtn: document.getElementById("create-offer-btn"),
      conciergeStatus: document.getElementById("concierge-status"),

      healthPill: document.getElementById("health-pill"),
      healthText: document.getElementById("health-text"),
      healthDetail: document.getElementById("health-detail"),
      retryHealthBtn: document.getElementById("retry-health-btn"),

      lastResponseBox: document.getElementById("last-response-box"),
      lastResponseMeta: document.getElementById("last-response-meta"),
      secondaryResponseBox: document.getElementById("secondary-response-box")
    };

    function setMode(mode) {
      const isGuest = mode === "guest";
      els.modeGuest.classList.toggle("active", isGuest);
      els.modeConcierge.classList.toggle("active", !isGuest);
      els.guestWorkspace.style.display = isGuest ? "block" : "none";
      els.conciergeWorkspace.style.display = isGuest ? "none" : "block";
    }

    function pretty(obj) {
      try {
        return JSON.stringify(obj, null, 2);
      } catch {
        return String(obj);
      }
    }

    function setLastResponse(data, meta) {
      els.lastResponseBox.textContent = pretty(data ?? {});
      els.lastResponseMeta.textContent = meta || "";
    }

    function setSecondary(data) {
      els.secondaryResponseBox.textContent = pretty(data ?? {});
    }

    function setHealthStatus(ok, payload) {
      els.healthPill.classList.toggle("ok", ok);
      els.healthPill.classList.toggle("err", !ok);
      els.healthText.textContent = ok ? "Backend healthy" : "Health check failed";
      els.healthDetail.textContent = ok
        ? `uptime ${Math.round(payload.uptime ?? 0)}s · ${payload.timestamp ?? ""}`
        : payload ? String(payload) : "";
    }

    async function checkHealth() {
      const url = `${API_BASE}/health`;
      els.healthText.textContent = "Checking…";
      els.healthDetail.textContent = `GET ${url}`;
      try {
        const res = await fetch(url);
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const data = await res.json();
        setHealthStatus(true, data);
        setLastResponse(data, `GET ${url}`);
      } catch (err) {
        const errObj = { error: "HEALTH_FAILED", message: String(err) };
        setHealthStatus(false, err);
        setLastResponse(errObj, `GET ${url} (failed)`);
      }
    }

    async function sendSignal() {
      const guest_id = els.guestId.value.trim();
      const intent = els.intent.value.trim();
      const location = els.location.value.trim();

      if (!guest_id || !intent) {
        alert("Please enter both guest id and intent.");
        return;
      }

      const body = { guest_id, intent };
      if (location) body.location = location;

      const url = `${API_BASE}/signals`;
      els.sendSignalBtn.disabled = true;
      els.sendSignalBtn.textContent = "Sending…";

      try {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw data;
        }
        setLastResponse(data, `POST ${url}`);
        els.guestOverviewStatus.textContent = "Signal created. Loading guest overview…";
        els.guestOverviewStatus.className = "status-line ok";
        await loadGuestOverview(guest_id);
      } catch (err) {
        setLastResponse(err, `POST ${url} (failed)`);
        els.guestOverviewStatus.textContent = "Failed to create signal.";
        els.guestOverviewStatus.className = "status-line err";
      } finally {
        els.sendSignalBtn.disabled = false;
        els.sendSignalBtn.textContent = "Send signal";
      }
    }

    async function loadGuestOverview(guestId) {
      const id = guestId || els.guestId.value.trim();
      if (!id) {
        alert("Enter a guest id first.");
        return;
      }
      const url = `${API_BASE}/guests/${encodeURIComponent(id)}/overview`;
      els.guestOverviewStatus.textContent = "Loading overview…";
      els.guestOverviewStatus.className = "status-line";

      try {
        const res = await fetch(url);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw data;
        setLastResponse(data, `GET ${url}`);
        setSecondary(data.messages || []);
        els.guestOverviewStatus.textContent = `Loaded overview for ${id}. Signals: ${
          data.summary?.signal_count ?? 0
        }, vibes: ${data.summary?.vibe_count ?? 0}`;
        els.guestOverviewStatus.className = "status-line ok";
      } catch (err) {
        setLastResponse(err, `GET ${url} (failed)`);
        els.guestOverviewStatus.textContent = "Failed to load guest overview.";
        els.guestOverviewStatus.className = "status-line err";
      }
    }

    async function listPendingSignals() {
      const url = `${API_BASE}/signals?status=pending`;
      els.conciergeStatus.textContent = "Loading pending signals…";
      els.conciergeStatus.className = "status-line";
      try {
        const res = await fetch(url);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw data;
        setLastResponse(data, `GET ${url}`);
        setSecondary(data.items || []);
        els.conciergeStatus.textContent = `Found ${data.count ?? 0} pending signals.`;
        els.conciergeStatus.className = "status-line ok";
      } catch (err) {
        setLastResponse(err, `GET ${url} (failed)`);
        els.conciergeStatus.textContent = "Failed to load pending signals.";
        els.conciergeStatus.className = "status-line err";
      }
    }

    async function createOffer() {
      const concierge_id = els.conciergeId.value.trim();
      const signal_id = els.offerSignalId.value.trim();
      const message = els.offerMessage.value.trim();
      const priceRaw = els.offerPrice.value.trim();

      if (!concierge_id || !signal_id || !message) {
        alert("Please provide concierge id, signal id and an offer message.");
        return;
      }

      const body = { concierge_id, signal_id, message };
      if (priceRaw) {
        const num = Number(priceRaw);
        if (!Number.isNaN(num)) body.price = num;
      }

      const url = `${API_BASE}/offers`;
      els.createOfferBtn.disabled = true;
      els.createOfferBtn.textContent = "Creating…";

      try {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw data;
        setLastResponse(data, `POST ${url}`);
        els.conciergeStatus.textContent = "Offer created.";
        els.conciergeStatus.className = "status-line ok";
      } catch (err) {
        setLastResponse(err, `POST ${url} (failed)`);
        els.conciergeStatus.textContent = "Failed to create offer.";
        els.conciergeStatus.className = "status-line err";
      } finally {
        els.createOfferBtn.disabled = false;
        els.createOfferBtn.textContent = "Create offer";
      }
    }

    // Wire events
    els.modeGuest.addEventListener("click", () => setMode("guest"));
    els.modeConcierge.addEventListener("click", () => setMode("concierge"));

    els.sendSignalBtn.addEventListener("click", sendSignal);
    els.refreshGuestOverviewBtn.addEventListener("click", () =>
      loadGuestOverview(els.guestId.value.trim())
    );

    els.listPendingBtn.addEventListener("click", listPendingSignals);
    els.createOfferBtn.addEventListener("click", createOffer);

    els.retryHealthBtn.addEventListener("click", checkHealth);

    // Initial health check on load
    window.addEventListener("load", () => {
      setMode("guest");
      checkHealth();
    });
  </script>
</body>
</html>
